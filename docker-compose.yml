name: clamav-api
services:
  clamav:
    image: clamav/clamav:latest
    platform: linux/amd64
    container_name: clamav
    restart: unless-stopped
    ports: 
    - "3310:3310"
    volumes:
      - clamav-db:/var/lib/clamav
    healthcheck:
      test: ["CMD", "clamdscan", "--ping", "3"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

  redis:
    image: redis:7-alpine
    container_name: clamav-redis
    restart: unless-stopped
    ports:
      - "6379:6379"

  minio:
    image: minio/minio:latest
    container_name: clamav-minio
    command: server /data --console-address ":9001"
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio-data:/data

  redpanda:
    image: redpandadata/redpanda:latest
    container_name: clamav-redpanda
    profiles: ["kafka", "all"]
    command:
      - redpanda start
      - --smp 1
      - --memory 512M
      - --overprovisioned
      - --kafka-addr PLAINTEXT://0.0.0.0:29092,OUTSIDE://0.0.0.0:9092
      - --advertise-kafka-addr PLAINTEXT://redpanda:29092,OUTSIDE://localhost:9092
    ports:
      - "9092:9092"
      - "29092:29092"

  console:
    image: docker.redpanda.com/redpandadata/console:latest
    container_name: clamav-console
    profiles: ["kafka", "all"]
    environment:
      KAFKA_BROKERS: "redpanda:29092"
    ports:
      - "8081:8080"
    depends_on:
      redpanda:
        condition: service_started

  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: clamav-rabbitmq
    profiles: ["rabbitmq", "all"]
    restart: unless-stopped
    environment:
      - RABBITMQ_DEFAULT_USER=guest
      - RABBITMQ_DEFAULT_PASS=guest
    ports:
      - "5672:5672"
      - "15672:15672"
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  kafka-init:
    image: redpandadata/redpanda:latest
    container_name: clamav-kafka-init
    profiles: ["kafka", "all"]
    environment:
      - KAFKA_TOPIC=scan-results
    entrypoint: >
      bash -c "
      echo 'Waiting for Redpanda to be ready...' &&
      rpk cluster health -X brokers=redpanda:29092 --wait || true &&
      echo 'Creating Kafka topic if it does not exist...' &&
      rpk topic create $$KAFKA_TOPIC --brokers redpanda:29092 --partitions 1 --replicas 1 || true &&
      echo 'Topic creation complete'
      "
    depends_on:
      redpanda:
        condition: service_started

  api:
    build: .
    container_name: clamav-api
    restart: unless-stopped
    command: ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8080", "--reload"]
    volumes:
      - ./:/app
    ports:
      - "8080:8080"
    environment:
      - CLAMAV_TYPE=tcp
      - CLAMAV_HOST=clamav
      - CLAMAV_PORT=3310
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      # - S3_ENDPOINT=http://minio:9000
      # - S3_ACCESS_KEY=minioadmin
      # - S3_SECRET_KEY=minioadmin
      # - S3_BUCKET=scans
      # - KAFKA_BOOTSTRAP_SERVERS=redpanda:29092
      # - KAFKA_TOPIC=scan-results
      # - RABBITMQ_HOST=rabbitmq
      # - RABBITMQ_PORT=5672
      # - RABBITMQ_USER=guest
      # - RABBITMQ_PASSWORD=guest
      # - RABBITMQ_QUEUE=scan-results
      # - ENABLE_KAFKA=true
      # - ENABLE_RABBITMQ=true
      # - ENABLE_S3=true
    depends_on:
      clamav:
        condition: service_healthy

volumes:
  clamav-db:
  minio-data:
